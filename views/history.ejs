<!DOCTYPE html>
<html>
<head>
    <title>æ­·å²ç´€éŒ„</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <meta name="theme-color" content="#388697">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* ğŸ”¥ FIX: Mobile Overscroll Color */
        html { background-color: #388697; } 
        body { background-color: #f8f9fa; min-height: 100vh; margin: 0; padding-top: 0; }

        .bg-primary { background-color: #388697 !important; }
        .text-primary { color: #388697 !important; }
        .btn-outline-primary { color: #388697; border-color: #388697; }
        .btn-outline-primary:hover, .btn-primary { background-color: #388697; border-color: #388697; color: white; }
        .amount-pos { color: green; font-weight: bold; }
        .amount-neg { color: red; font-weight: bold; }
        .table-text-small { font-size: 0.9rem; }
        .dropdown-item { padding: 10px 15px; font-size: 1rem; }
        .void-row { text-decoration: line-through; color: #adb5bd; }
        .navbar { margin-top: 0 !important; padding-top: 10px; padding-bottom: 10px; min-height: 60px; }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-primary mb-3">
    <div class="container-fluid position-relative">
        <div class="d-flex align-items-center"><a class="navbar-brand p-0 m-0" href="/activity/<%= activity.id %>"><span class="fs-4">â¬…ï¸</span></a></div>
        <div class="position-absolute top-50 start-50 translate-middle w-50 text-center"><div class="text-white fw-bold fs-5 text-truncate"><%= activity.name %></div></div>
        <div class="d-flex align-items-center gap-2">
            <div class="dropdown">
                <button class="btn btn-link text-white text-decoration-none p-0 fs-3" type="button" data-bs-toggle="dropdown">âš™ï¸</button>
                <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0" style="min-width: 200px;">
                    <li><a class="dropdown-item" href="/activity/<%= activity.id %>">ğŸ  <span data-i18n="menu_return">è¿”å›è¨˜æ•¸</span></a></li>
                    <li><a class="dropdown-item" href="/activity/<%= activity.id %>/users">ğŸ‘¥ <span data-i18n="menu_members">æœƒå“¡ç®¡ç†</span></a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><button class="dropdown-item" onclick="toggleLanguage()">ğŸŒ <span id="langLabel">ENG</span></button></li>
                </ul>
            </div>
        </div>
    </div>
</nav>

<div class="container">
    <h4 class="mb-3">ğŸ“œ <span data-i18n="title_history">æ­·å²ç´€éŒ„</span></h4>
    <% if (groupedTransactions.length === 0) { %>
        <div class="alert alert-info text-center" data-i18n="no_records">æš«æ™‚æœªæœ‰ä»»ä½•äº¤æ˜“ç´€éŒ„ã€‚</div>
    <% } else { %>
        <% groupedTransactions.forEach(group => { %>
            <div class="card shadow-sm mb-3">
                <div class="card-header d-flex justify-content-between align-items-center bg-white">
                    <div>
                        <div class="fw-bold text-primary"><%= group.date.toISOString().substring(0, 10) %> <% if(group.isBowling) { %> ğŸ³ Bowling <% } %><% if(group.isPickle) { %> ğŸ¥’ Pickleball <% } %><% if(group.type === 'deposit') { %> ğŸ’° Deposit <% } %></div>
                        <div class="small text-muted"><%= group.date.toISOString().substring(11, 16) %></div>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="fs-5 fw-bold text-dark">$<%= group.total.toFixed(2) %></span>
                        <% if(group.type === 'expense') { %><button class="btn btn-sm btn-outline-secondary py-0 px-2" onclick="handleEdit('<%= group.timestamp %>', '<%= group.total %>', <%= group.isBowling %>)">âœï¸</button><% } %>
                    </div>
                </div>
                <div class="card-body p-0">
                    <table class="table table-striped mb-0 align-middle">
                        <tbody>
                            <% group.records.forEach(t => { %>
                                <tr class="<%= t.type === 'void' ? 'void-row' : '' %>">
                                    <td class="ps-3 table-text-small"><div class="fw-bold"><%= t.name || 'Unknown' %></div><div class="text-muted small"><%= t.description %></div></td>
                                    <td class="text-end pe-3 table-text-small">
                                        <% if(t.type === 'void') { %> $0.00 <% } else { %> <span class="<%= t.amount >= 0 ? 'amount-pos' : 'amount-neg' %>"><%= t.amount.toFixed(2) %></span> <% } %>
                                        <% if(t.type !== 'void') { %> <form action="/activity/<%= activity.id %>/delete-transaction" method="POST" class="d-inline ms-2"><input type="hidden" name="id" value="<%= t.id %>"><button class="btn btn-sm btn-link text-danger p-0" style="text-decoration: none;">ğŸ—‘ï¸</button></form> <% } %>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
        <% }) %>
    <% } %>
    <div class="modal fade" id="editGroupModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">ä¿®æ”¹ç¸½é‡‘é¡ (Pickleball)</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><form action="/activity/<%= activity.id %>/update-group-total" method="POST"><div class="modal-body"><input type="hidden" name="timestamp" id="editGroupTimestamp"><label class="form-label">æ–°ç¸½é‡‘é¡ ($)</label><input type="number" step="0.01" name="newTotal" id="editGroupTotal" class="form-control" required></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button><button type="submit" class="btn btn-primary">ä¿å­˜</button></div></form></div></div></div>
    <div class="modal fade" id="editBowlingModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">ä¿®æ”¹ Bowling ç´€éŒ„</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><form action="/activity/<%= activity.id %>/update-bowling-session" method="POST"><div class="modal-body"><input type="hidden" name="timestamp" id="bowlingTimestamp"><div class="mb-3"><label class="form-label fw-bold">ç¸½é‡‘é¡ ($)</label><input type="number" step="0.01" name="totalCost" id="bowlingTotalCost" class="form-control" required></div><div class="mb-3"><label class="form-label fw-bold">Guest (ç¨ç«‹å±€æ•¸)</label><div class="input-group"><span class="input-group-text bg-secondary text-white">ğŸ‘¥</span><input type="number" name="guestGames" id="bowlingGuestGames" class="form-control" placeholder="0"></div></div><label class="form-label fw-bold">æœƒå“¡å±€æ•¸ (Member)</label><div class="card card-body bg-light p-2" style="max-height: 250px; overflow-y: auto;"><% users.forEach(user => { %><div class="d-flex justify-content-between align-items-center mb-2"><label class="mb-0 text-truncate" style="width: 50%;"><%= user.name %></label><input type="number" name="userGames[<%= user.id %>]" id="user-game-<%= user.id %>" class="form-control form-control-sm w-50 text-center" placeholder="0"></div><% }) %></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button><button type="submit" class="btn btn-primary">ä¿å­˜é‡ç®—</button></div></form></div></div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const translations = { zh: { title_history: "æ­·å²ç´€éŒ„", no_records: "æš«æ™‚æœªæœ‰ä»»ä½•äº¤æ˜“ç´€éŒ„ã€‚", menu_return: "è¿”å›è¨˜æ•¸", menu_members: "æœƒå“¡ç®¡ç†" }, en: { title_history: "History", no_records: "No transaction records yet.", menu_return: "Back to Record", menu_members: "Members" } };
    let currentLang = localStorage.getItem('appLang') || 'zh';
    function applyLanguage() { const langData = translations[currentLang]; document.querySelectorAll('[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); if (langData[key]) el.innerText = langData[key]; }); }
    function toggleLanguage() { currentLang = currentLang === 'zh' ? 'en' : 'zh'; localStorage.setItem('appLang', currentLang); applyLanguage(); }
    applyLanguage();
    const editGroupModal = new bootstrap.Modal(document.getElementById('editGroupModal')), editBowlingModal = new bootstrap.Modal(document.getElementById('editBowlingModal'));
    function handleEdit(timestamp, total, isBowling) { const formattedTotal = parseFloat(total).toFixed(2); if (isBowling) { document.getElementById('bowlingTimestamp').value = timestamp; document.getElementById('bowlingTotalCost').value = formattedTotal; document.getElementById('bowlingGuestGames').value = ''; document.querySelectorAll('[id^="user-game-"]').forEach(el => el.value = ''); fetch(`/activity/<%= activity.id %>/session/${timestamp}/details`).then(res => res.json()).then(data => { if (data.guestGames) document.getElementById('bowlingGuestGames').value = data.guestGames; if (data.userGames) { for (const [uid, count] of Object.entries(data.userGames)) { const input = document.getElementById('user-game-' + uid); if (input) input.value = count; } } editBowlingModal.show(); }); } else { document.getElementById('editGroupTimestamp').value = timestamp; document.getElementById('editGroupTotal').value = formattedTotal; editGroupModal.show(); } }
</script>
</body>
</html>