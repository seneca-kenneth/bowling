<!DOCTYPE html>
<html>
<head>
    <title>æ­·å²ç´€éŒ„</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <meta name="theme-color" content="#388697">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .bg-primary { background-color: #388697 !important; }
        .text-primary { color: #388697 !important; }
        .btn-outline-primary { color: #388697; border-color: #388697; }
        .btn-outline-primary:hover, .btn-primary { background-color: #388697; border-color: #388697; color: white; }
        .amount-pos { color: green; font-weight: bold; }
        .amount-neg { color: red; font-weight: bold; }
        .table-text-small { font-size: 0.9rem; }
        .dropdown-item { padding: 10px 15px; font-size: 1rem; }
        
        .btn-check:checked + .btn-outline-primary {
            background-color: #388697; color: white;
        }
        
        /* è¨ªå®¢æŒ‰éˆ•æ¨£å¼ (åŒ Index ä¸€æ¨£) */
        .guest-btn { 
            width: 25px; height: 25px; padding: 0; line-height: 23px; 
            border-radius: 50%; background: white; color: #388697; border: 1px solid #388697; font-weight: bold;
        }

        ::-webkit-scrollbar { display: none; }
        html, body { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-primary mb-3">
    <div class="container-fluid position-relative">
        <div class="d-flex align-items-center">
            <a class="navbar-brand p-0 m-0" href="/activity/<%= activity.id %>">
                <span class="fs-4">â¬…ï¸</span>
            </a>
        </div>
        <div class="position-absolute top-50 start-50 translate-middle w-50 text-center">
            <div class="text-white fw-bold fs-5 text-truncate"><%= activity.name %></div>
        </div>
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-outline-light border-0" onclick="toggleLanguage()">ğŸŒ <span id="langLabel">ENG</span></button>
            <div class="dropdown">
                <button class="btn btn-link text-white text-decoration-none p-0 fs-3" type="button" data-bs-toggle="dropdown">âš™ï¸</button>
                <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0" style="min-width: 200px;">
                    <li><a class="dropdown-item" href="/activity/<%= activity.id %>">ğŸ  <span data-i18n="menu_return">è¿”å›è¨˜æ•¸</span></a></li>
                    <li><a class="dropdown-item" href="/activity/<%= activity.id %>/users">ğŸ‘¥ <span data-i18n="menu_members">æœƒå“¡ç®¡ç†</span></a></li>
                </ul>
            </div>
        </div>
    </div>
</nav>

<div class="container">
    <h4 class="mb-3">ğŸ“œ <%= activity.name %> - <span data-i18n="title_suffix">ç´€éŒ„</span></h4>

    <% if (transactions.length === 0) { %>
        <div class="alert alert-info text-center" data-i18n="no_records">æš«æ™‚æœªæœ‰ä»»ä½•äº¤æ˜“ç´€éŒ„ã€‚</div>
    <% } else { %>
        <div class="card shadow-sm">
            <div class="table-responsive">
                <table class="table table-striped align-middle mb-0">
                    <thead class="table-dark small">
                        <tr>
                            <th data-i18n="th_time_user">æ™‚é–“/äººç‰©</th>
                            <th data-i18n="th_details">è©³æƒ…</th>
                            <th class="text-end" data-i18n="th_amount">é‡‘é¡</th>
                            <th class="text-end" data-i18n="th_action">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% transactions.forEach(t => { %>
                            <tr>
                                <td class="table-text-small">
                                    <div class="fw-bold"><%= t.name || 'Unknown' %></div>
                                    <div class="text-muted" style="font-size: 0.75rem;">
                                        <%= t.date.replace('T', ' ').substring(0, 16) %>
                                    </div>
                                </td>
                                <td class="table-text-small">
                                    <%= t.description %>
                                    <% if(t.type === 'deposit') { %>
                                        <span class="badge bg-success" style="font-size: 0.6rem;" data-i18n="badge_deposit">å…¥æ•¸</span>
                                    <% } %>
                                </td>
                                <td class="text-end table-text-small <%= t.amount >= 0 ? 'amount-pos' : 'amount-neg' %>">
                                    <%= t.amount > 0 ? '+' : '' %><%= t.amount.toFixed(1) %>
                                </td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-outline-secondary py-0 px-1 btn-edit" 
                                        data-id="<%= t.id %>" 
                                        data-desc="<%= t.description %>" 
                                        data-amount="<%= Math.abs(t.amount) %>"
                                        data-type="<%= t.type %>"
                                        data-act-id="<%= activity.id %>">
                                        âœï¸
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger py-0 px-1 btn-delete" 
                                        data-id="<%= t.id %>">
                                        ğŸ—‘ï¸
                                    </button>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        </div>
    <% } %>

    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" data-i18n="modal_del_title">åˆªé™¤ç´€éŒ„</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form action="/activity/<%= activity.id %>/delete-transaction" method="POST">
                    <div class="modal-body">
                        <input type="hidden" name="id" id="deleteTransId">
                        <p data-i18n="confirm_del_record">ç¢ºå®šè¦åˆªé™¤é€™æ¢ç´€éŒ„å—ï¼Ÿ</p>
                        <p class="text-danger small" data-i18n="hint_del_restore">åˆªé™¤å¾Œï¼Œè©²ç”¨æˆ¶çš„é¤˜é¡æœƒè‡ªå‹•é‚„åŸã€‚<br>(è‹¥æ˜¯å¤¾éŒ¢ç´€éŒ„ï¼Œå‰©é¤˜è€…å°‡æœƒé‡æ–°è¨ˆç®—)</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="btn_cancel">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-danger" data-i18n="btn_confirm_delete">ç¢ºèªåˆªé™¤</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" data-i18n="modal_edit_title">ä¿®æ”¹ç´€éŒ„</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form action="/activity/<%= activity.id %>/update-transaction" method="POST">
                    <div class="modal-body">
                        <input type="hidden" name="id" id="editTransId">
                        <div class="mb-3">
                            <label class="form-label text-muted"><span data-i18n="label_original">åŸæœ¬å…§å®¹</span>: <span id="editTransDesc" class="fw-bold text-dark"></span></label>
                        </div>
                        
                        <div id="editGameSection" class="d-none">
                            <label class="form-label" data-i18n="label_new_games">ä¿®æ­£ç‚ºå¤šå°‘å±€ï¼Ÿ</label>
                            <input type="number" name="newGameCount" id="inputGameCount" class="form-control" min="1" placeholder="3">
                        </div>

                        <div id="editAmountSection" class="d-none">
                            <label class="form-label" data-i18n="label_new_amount">ä¿®æ­£é‡‘é¡ ($)</label>
                            <input type="number" step="0.1" name="newAmount" id="inputAmount" class="form-control" placeholder="100">
                        </div>

                        <div id="editParticipantsSection" class="d-none mt-3">
                            <label class="form-label fw-bold" data-i18n="label_participants">ä¿®æ”¹åƒèˆ‡è€…</label>
                            <div class="card card-body bg-light p-2" style="max-height: 250px; overflow-y: auto;">
                                <div class="row g-2">
                                    <% users.forEach(user => { %>
                                        <div class="col-6">
                                            <input type="checkbox" class="btn-check group-checkbox" 
                                                   name="selectedUsers" value="<%= user.id %>" id="chk-<%= user.id %>">
                                            
                                            <label class="btn btn-outline-primary btn-sm w-100 p-2" for="chk-<%= user.id %>">
                                                <div class="fw-bold"><%= user.name %></div>
                                                <div class="d-flex justify-content-center align-items-center gap-1 mt-1" onclick="event.preventDefault()">
                                                    <button type="button" class="guest-btn" onclick="changeEditUserGuest('<%= user.id %>', -1)">-</button>
                                                    <span class="small text-muted fw-bold">ğŸ‘¤+<span id="guest-display-<%= user.id %>">0</span></span>
                                                    <button type="button" class="guest-btn" onclick="changeEditUserGuest('<%= user.id %>', 1)">+</button>
                                                    <input type="hidden" name="guests[uid_<%= user.id %>]" id="guest-input-<%= user.id %>" value="0">
                                                </div>
                                            </label>
                                        </div>
                                    <% }) %>
                                </div>
                            </div>
                            <div class="small text-muted mt-1" data-i18n="hint_recalc">
                                ç³»çµ±æœƒåˆªé™¤èˆŠæœ‰ç´€éŒ„ï¼Œä¸¦æ ¹æ“šæ–°é¸æ“‡çš„äººæ•¸åŠæ¬Šé‡é‡æ–°åˆ†é…ã€‚
                            </div>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="btn_cancel">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary" data-i18n="btn_save_changes">ä¿å­˜ä¿®æ”¹</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const translations = {
        zh: {
            nav_back: "è¿”å›è¨˜æ•¸",
            title_suffix: "ç´€éŒ„",
            no_records: "æš«æ™‚æœªæœ‰ä»»ä½•äº¤æ˜“ç´€éŒ„ã€‚",
            th_time_user: "æ™‚é–“/äººç‰©",
            th_details: "è©³æƒ…",
            th_amount: "é‡‘é¡",
            th_action: "æ“ä½œ",
            badge_deposit: "å…¥æ•¸",
            modal_del_title: "åˆªé™¤ç´€éŒ„",
            confirm_del_record: "ç¢ºå®šè¦åˆªé™¤é€™æ¢ç´€éŒ„å—ï¼Ÿ",
            hint_del_restore: "åˆªé™¤å¾Œï¼Œè©²ç”¨æˆ¶çš„é¤˜é¡æœƒè‡ªå‹•é‚„åŸã€‚<br>(è‹¥æ˜¯å¤¾éŒ¢ç´€éŒ„ï¼Œå‰©é¤˜è€…å°‡æœƒé‡æ–°è¨ˆç®—)",
            btn_cancel: "å–æ¶ˆ",
            btn_confirm_delete: "ç¢ºèªåˆªé™¤",
            modal_edit_title: "ä¿®æ”¹ç´€éŒ„",
            label_original: "åŸæœ¬å…§å®¹",
            label_new_games: "ä¿®æ­£ç‚ºå¤šå°‘å±€ï¼Ÿ",
            label_new_amount: "ä¿®æ­£é‡‘é¡ ($)",
            label_participants: "ä¿®æ”¹åƒèˆ‡è€… (åŠ æ¬Šè¨ˆç®—)",
            hint_recalc: "ç³»çµ±æœƒæ ¹æ“šæ–°é¸æ“‡çš„äººæ•¸åŠ Guest é‡æ–°åˆ†é…ã€‚",
            btn_save_changes: "ä¿å­˜ä¿®æ”¹",
            menu_return: "è¿”å›è¨˜æ•¸",
            menu_members: "æœƒå“¡ç®¡ç†"
        },
        en: {
            nav_back: "Back",
            title_suffix: "History",
            no_records: "No transaction records yet.",
            th_time_user: "Time/User",
            th_details: "Details",
            th_amount: "Amount",
            th_action: "Action",
            badge_deposit: "Deposit",
            modal_del_title: "Delete Record",
            confirm_del_record: "Are you sure you want to delete this record?",
            hint_del_restore: "Balance will be restored. (Split bills will be recalculated)",
            btn_cancel: "Cancel",
            btn_confirm_delete: "Delete",
            modal_edit_title: "Edit Record",
            label_original: "Original",
            label_new_games: "New Game Count",
            label_new_amount: "New Amount ($)",
            label_participants: "Edit Participants (Weighted)",
            hint_recalc: "System will redistribute cost based on selection and guests.",
            btn_save_changes: "Save Changes",
            menu_return: "Back to Record",
            menu_members: "Members"
        }
    };

    let currentLang = localStorage.getItem('appLang') || 'zh';

    function applyLanguage() {
        const langData = translations[currentLang];
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (langData[key]) el.innerHTML = langData[key];
        });
        document.getElementById('langLabel').innerText = currentLang === 'zh' ? 'ä¸­' : 'ENG';
    }

    function toggleLanguage() {
        currentLang = currentLang === 'zh' ? 'en' : 'zh';
        localStorage.setItem('appLang', currentLang);
        applyLanguage();
    }

    applyLanguage();

    // ğŸ”¥ Edit Modal Guest Logic
    function changeEditUserGuest(userId, delta) {
        const input = document.getElementById('guest-input-' + userId);
        const display = document.getElementById('guest-display-' + userId);
        const checkbox = document.getElementById('chk-' + userId);

        let val = parseInt(input.value) || 0;
        val += delta;
        if (val < 0) val = 0;
        
        input.value = val;
        display.innerText = val;

        if (val > 0 && !checkbox.checked) {
            checkbox.checked = true;
        }
    }

    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', function() {
            document.getElementById('deleteTransId').value = this.dataset.id;
            deleteModal.show();
        });
    });

    const editModal = new bootstrap.Modal(document.getElementById('editModal'));
    
    document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            const desc = this.dataset.desc;
            const amount = this.dataset.amount;
            const type = this.dataset.type;
            const actId = this.dataset.actId;

            document.getElementById('editTransId').value = id;
            document.getElementById('editTransDesc').innerText = desc;

            const gameSection = document.getElementById('editGameSection');
            const amountSection = document.getElementById('editAmountSection');
            const participantsSection = document.getElementById('editParticipantsSection');
            const gameInput = document.getElementById('inputGameCount');
            const amountInput = document.getElementById('inputAmount');

            // Reset UI
            gameInput.value = '';
            amountInput.value = '';
            gameSection.classList.add('d-none');
            amountSection.classList.add('d-none');
            participantsSection.classList.add('d-none');
            
            // Reset checkboxes and guests
            document.querySelectorAll('.group-checkbox').forEach(cb => cb.checked = false);
            document.querySelectorAll('[id^="guest-input-"]').forEach(el => el.value = 0);
            document.querySelectorAll('[id^="guest-display-"]').forEach(el => el.innerText = 0);

            if (type === 'expense' && desc.includes('å±€')) {
                gameSection.classList.remove('d-none');
                const match = desc.match(/(\d+)/);
                if(match) gameInput.value = match[0];
            } 
            else if (type === 'expense' && desc.includes('å…±$')) {
                amountSection.classList.remove('d-none');
                participantsSection.classList.remove('d-none'); 
                
                const match = desc.match(/å…±\$(\d+(\.\d+)?)/);
                if(match) amountInput.value = match[1];

                // ğŸ”¥ AJAX: Get participants AND their guests
                fetch(`/activity/${actId}/transaction/${id}/group`)
                    .then(res => res.json())
                    .then(users => {
                        users.forEach(u => {
                            const cb = document.getElementById('chk-' + u.user_id);
                            if(cb) cb.checked = true;
                            
                            // Fill in Guest Count
                            if (u.guests > 0) {
                                document.getElementById('guest-input-' + u.user_id).value = u.guests;
                                document.getElementById('guest-display-' + u.user_id).innerText = u.guests;
                            }
                        });
                    });
            }
            else {
                amountSection.classList.remove('d-none');
                amountInput.value = amount;
            }

            editModal.show();
        });
    });
</script>
</body>
</html>