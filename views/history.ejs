<!DOCTYPE html>
<html>
<head>
    <title>æ­·å²ç´€éŒ„</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <meta name="theme-color" content="#388697">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #388697;
            --bg-color: #F2F4F6;
            --card-bg: #FFFFFF;
            --text-main: #1C1C1E;
            --danger-color: #FF3B30;
            --success-color: #34C759;
            --radius-lg: 20px;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
            --header-height: 60px;
        }
        body {
            background-color: var(--bg-color); color: var(--text-main);
            padding-top: calc(var(--header-height) + 20px); padding-bottom: 100px;
            min-height: 100vh; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        /* Header */
        .top-nav {
            position: fixed; top: 0; left: 0; right: 0; height: var(--header-height);
            background: var(--primary-color); color: white;
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
            z-index: 1000; padding-top: env(safe-area-inset-top); height: calc(var(--header-height) + env(safe-area-inset-top));
            box-shadow: 0 4px 12px rgba(56, 134, 151, 0.2);
        }
        .top-nav-title { font-weight: 700; font-size: 18px; }
        .nav-btn { color: white; font-size: 1.2rem; text-decoration: none; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px;}

        /* Card */
        .modern-card { background: var(--card-bg); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); padding: 0; margin-bottom: 16px; overflow: hidden; border: none; }
        .card-header-modern { padding: 16px; border-bottom: 1px solid #F2F4F6; display: flex; justify-content: space-between; align-items: center; }
        .amount-pos { color: var(--success-color); font-weight: bold; }
        .amount-neg { color: var(--danger-color); font-weight: bold; }
        .void-row { text-decoration: line-through; opacity: 0.5; }
        
        /* Bottom Nav */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; height: 80px; background: #FFFFFF;
            border-top: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-around; align-items: flex-start;
            padding-top: 12px; z-index: 1000; padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #C7C7CC; font-size: 0.75rem; font-weight: 500; width: 60px; }
        .nav-item i { font-size: 1.4rem; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary-color); }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

<div class="top-nav">
    <a href="/activity/<%= activity.id %>" class="nav-btn"><i class="fa-solid fa-chevron-left"></i></a>
    <div class="top-nav-title">æ­·å²ç´€éŒ„</div>
    <div style="width: 40px;"></div> </div>

<div class="container">
    <% if (groupedTransactions.length === 0) { %>
        <div class="text-center text-muted py-5">æš«æ™‚æœªæœ‰ç´€éŒ„</div>
    <% } else { %>
        <% groupedTransactions.forEach(group => { %>
            <div class="modern-card">
                <div class="card-header-modern">
                    <div>
                        <div style="font-weight: 700; color: var(--primary-color);">
                            <%= group.date.toISOString().substring(0, 10) %> 
                            <% if(group.isBowling) { %> ğŸ³ <% } %>
                            <% if(group.type === 'deposit') { %> ğŸ’° Deposit <% } %>
                        </div>
                        <div class="small text-muted"><%= group.date.toISOString().substring(11, 16) %></div>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="fs-5 fw-bold text-dark">$<%= group.total.toFixed(2) %></span>
                        <% if(group.type === 'expense') { %>
                            <button class="btn btn-sm btn-light rounded-circle" onclick="handleEdit('<%= group.timestamp %>', '<%= group.total %>', <%= group.isBowling %>)"><i class="fa-solid fa-pen"></i></button>
                        <% } %>
                    </div>
                </div>
                <table class="table mb-0 align-middle">
                    <tbody>
                        <% group.records.forEach(t => { %>
                            <tr class="<%= t.type === 'void' ? 'void-row' : '' %>">
                                <td class="ps-3 border-0">
                                    <div class="fw-bold"><%= t.name || 'Unknown' %></div>
                                    <div class="text-muted small"><%= t.description %></div>
                                </td>
                                <td class="text-end pe-3 border-0">
                                    <% if(t.type !== 'void') { %>
                                        <span class="<%= t.amount >= 0 ? 'amount-pos' : 'amount-neg' %>"><%= t.amount.toFixed(2) %></span>
                                        <form action="/activity/<%= activity.id %>/delete-transaction" method="POST" class="d-inline ms-2">
                                            <input type="hidden" name="id" value="<%= t.id %>">
                                            <button class="btn btn-sm btn-link text-danger p-0"><i class="fa-regular fa-trash-can"></i></button>
                                        </form>
                                    <% } else { %>
                                        $0.00
                                    <% } %>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        <% }) %>
    <% } %>
    
    <div class="modal fade" id="editGroupModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">ä¿®æ”¹ç¸½é‡‘é¡</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><form action="/activity/<%= activity.id %>/update-group-total" method="POST"><div class="modal-body"><input type="hidden" name="timestamp" id="editGroupTimestamp"><label class="form-label">æ–°ç¸½é‡‘é¡ ($)</label><input type="number" step="0.01" name="newTotal" id="editGroupTotal" class="form-control" required></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button><button type="submit" class="btn btn-primary">ä¿å­˜</button></div></form></div></div></div>
    <div class="modal fade" id="editBowlingModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">ä¿®æ”¹ç´€éŒ„</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><form action="/activity/<%= activity.id %>/update-bowling-session" method="POST"><div class="modal-body"><input type="hidden" name="timestamp" id="bowlingTimestamp"><div class="mb-3"><label class="form-label fw-bold">ç¸½é‡‘é¡ ($)</label><input type="number" step="0.01" name="totalCost" id="bowlingTotalCost" class="form-control" required></div><div class="mb-3"><label class="form-label fw-bold">Guest (ç¨ç«‹å±€æ•¸)</label><input type="number" name="guestGames" id="bowlingGuestGames" class="form-control" placeholder="0"></div><label class="form-label fw-bold">æœƒå“¡å±€æ•¸</label><div class="card card-body bg-light p-2" style="max-height: 250px; overflow-y: auto;"><% users.forEach(user => { %><div class="d-flex justify-content-between align-items-center mb-2"><label class="mb-0 text-truncate" style="width: 50%;"><%= user.name %></label><input type="number" name="userGames[<%= user.id %>]" id="user-game-<%= user.id %>" class="form-control form-control-sm w-50 text-center" placeholder="0"></div><% }) %></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button><button type="submit" class="btn btn-primary">ä¿å­˜é‡ç®—</button></div></form></div></div></div>
</div>

<div class="bottom-nav">
    <a href="/activity/<%= activity.id %>" class="nav-item"><i class="fa-solid fa-pen-to-square"></i><span>è¨˜æ•¸</span></a>
    <a href="/activity/<%= activity.id %>/history" class="nav-item active"><i class="fa-solid fa-clock-rotate-left"></i><span>ç´€éŒ„</span></a>
    <a href="/activity/<%= activity.id %>/users" class="nav-item"><i class="fa-solid fa-users"></i><span>æˆå“¡</span></a>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const editGroupModal = new bootstrap.Modal(document.getElementById('editGroupModal'));
    const editBowlingModal = new bootstrap.Modal(document.getElementById('editBowlingModal'));
    function handleEdit(timestamp, total, isBowling) {
        const formattedTotal = parseFloat(total).toFixed(2);
        if (isBowling) {
            document.getElementById('bowlingTimestamp').value = timestamp;
            document.getElementById('bowlingTotalCost').value = formattedTotal;
            document.getElementById('bowlingGuestGames').value = '';
            document.querySelectorAll('[id^="user-game-"]').forEach(el => el.value = '');
            fetch(`/activity/<%= activity.id %>/session/${timestamp}/details`).then(res => res.json()).then(data => {
                if (data.guestGames) document.getElementById('bowlingGuestGames').value = data.guestGames;
                if (data.userGames) { for (const [uid, count] of Object.entries(data.userGames)) { const input = document.getElementById('user-game-' + uid); if (input) input.value = count; } }
                editBowlingModal.show();
            });
        } else {
            document.getElementById('editGroupTimestamp').value = timestamp;
            document.getElementById('editGroupTotal').value = formattedTotal;
            editGroupModal.show();
        }
    }
</script>
</body>
</html>